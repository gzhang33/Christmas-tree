<story-context id="2-0-test-infra" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2-0</storyId>
    <title>Test Infrastructure &amp; Video Prep</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-0-test-infra.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>to set up the testing framework and prepare video assets</iWant>
    <soThat>the project is stable and supports the new video requirements</soThat>
    <tasks>
- [ ] Install testing dependencies: `vitest`, `@testing-library/react`, `@testing-library/jest-dom` (AC: 1)
- [ ] Configure Vitest in `vite.config.ts` or create `vitest.config.ts` (AC: 1)
- [ ] Uncomment and update `src/store/useStore.test.ts` with proper imports and test setup (AC: 2)
- [ ] Verify `src/config/assets.ts` contains video paths in `MEMORIES` array (AC: 3)
- [ ] Fix memory leak in `App.tsx`:
  - [ ] Add cleanup effect to revoke object URLs when photos are removed or component unmounts (AC: 4)
  - [ ] Ensure `URL.revokeObjectURL` is called for all created object URLs (AC: 4)
- [ ] Add `test` script to `package.json` (AC: 5)
- [ ] Run tests to verify they pass (AC: 2, 5)
    </tasks>
  </story>

  <acceptanceCriteria>
1. `vitest` and `@testing-library/react` are installed and configured.
2. `src/store/useStore.test.ts` is uncommented and contains passing unit tests for `useStore`.
3. `src/config/assets.ts` already includes video file paths in `MEMORIES` array (verified).
4. The `URL.createObjectURL` memory leak in `App.tsx` is fixed with proper cleanup using `URL.revokeObjectURL`.
5. A test script is added to `package.json` to run tests.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.0: Test Infrastructure &amp; Video Prep</section>
        <snippet>
As a Developer,
I want to set up the testing framework and prepare video assets,
So that the project is stable and supports the new video requirements.

Acceptance Criteria:
- Install and configure `vitest`
- Create `src/store/useStore.test.ts`
- Update `Asset` type to support `videoUrl`
- Fix the `URL.createObjectURL` memory leak in `Controls.tsx`
        </snippet>
      </doc>
      <doc>
        <path>docs/stories/epic-1-retro-2025-12-02.md</path>
        <title>Epic 1 Retrospective</title>
        <section>3. Action Items</section>
        <snippet>
Technical Debt &amp; Preparation (For Epic 2):
1. [Critical] Configure Vitest: Install and configure Vitest to enable unit testing for `useStore` and future physics logic.
2. [Medium] Memory Leak Fix: Implement `URL.revokeObjectURL` cleanup in `Controls.tsx`.
        </snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Document</title>
        <section>6. Implementation Patterns</section>
        <snippet>
Asset Management:
- No Hardcoding: `src/assets/image.png` is forbidden in components.
- Registry: Use `src/config/assets.ts`
        </snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>src/store/useStore.test.ts</path>
        <kind>file</kind>
        <symbol>useStore.test</symbol>
        <lines>1-62</lines>
        <reason>Test file exists but is commented out. Needs to be uncommented and configured with Vitest.</reason>
      </item>
      <item>
        <path>src/App.tsx</path>
        <kind>file</kind>
        <symbol>addPhotos</symbol>
        <lines>172-178</lines>
        <reason>Contains `URL.createObjectURL` call without cleanup. Needs `URL.revokeObjectURL` in cleanup effect.</reason>
      </item>
      <item>
        <path>src/config/assets.ts</path>
        <kind>file</kind>
        <symbol>MEMORIES</symbol>
        <lines>24-38</lines>
        <reason>Already contains video paths. Needs verification that structure matches requirements.</reason>
      </item>
      <item>
        <path>package.json</path>
        <kind>file</kind>
        <symbol>scripts</symbol>
        <lines>6-10</lines>
        <reason>Needs `test` script added to run Vitest.</reason>
      </item>
      <item>
        <path>vite.config.ts</path>
        <kind>file</kind>
        <symbol>viteConfig</symbol>
        <reason>May need Vitest configuration added, or separate `vitest.config.ts` created.</reason>
      </item>
    </code>
    <dependencies>
      <package name="vitest" version="latest" />
      <package name="@testing-library/react" version="latest" />
      <package name="@testing-library/jest-dom" version="latest" />
      <package name="zustand" version="^5.0.9" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Vitest should be configured to work with Vite's existing setup.</constraint>
    <constraint>Tests must run in Node.js environment (not browser) for CI/CD compatibility.</constraint>
    <constraint>Memory leak fix must handle both component unmount and photo removal scenarios.</constraint>
    <constraint>Video asset structure in `assets.ts` should support both image and video URLs per memory item.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PhotoData</name>
      <kind>interface</kind>
      <signature>
interface PhotoData {
    id: string;
    url: string;
}
      </signature>
      <path>src/types.ts</path>
      <reason>Used in `addPhotos` function. May need to extend to support video URLs.</reason>
    </interface>
    <interface>
      <name>Memory</name>
      <kind>type</kind>
      <signature>
type Memory = {
    id: string;
    image: string;
    video: string | null;
}
      </signature>
      <path>src/config/assets.ts</path>
      <reason>Already supports video paths. Structure verified in this story.</reason>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Run `npm test` to execute all unit tests.
      Verify that `useStore` tests pass with proper state management.
      Check that memory leak is fixed by monitoring browser memory during photo upload/removal cycles.
    </standards>
    <locations>
      src/store/useStore.test.ts
    </locations>
    <ideas>
      Test that `useStore` initializes with default values.
      Test that `setTheme` updates the theme state.
      Test that `setParticleCount` updates the particle count.
      Test that `triggerExplosion` and `resetExplosion` toggle the explosion state.
      Test that `setActivePhoto` updates the active photo ID.
      Test that persistence middleware saves and restores state from LocalStorage.
    </ideas>
  </tests>
</story-context>


