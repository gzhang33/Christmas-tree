<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.2</storyId>
    <title>Explosion Physics &amp; Shader Upgrade</title>
    <status>drafted</status>
    <generatedAt>2025-12-04T23:24:34Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>e:\OpenSources\Christmas-tree\docs\stories\2-2-explosion-physics.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>the tree to explode with a specific "radial force" and "damping" effect</iWant>
    <soThat>it feels like a release of energy rather than just linear movement</soThat>
    <tasks>
- [ ] Implement `particle.vert` shader with Bezier interpolation logic (AC: #2, #3)
  - [ ] Define attributes: `positionStart`, `positionEnd`, `controlPoint`
  - [ ] Define uniforms: `uProgress`, `uTime`
  - [ ] Implement quadratic bezier function
  - [ ] Test shader compilation
- [ ] Implement `particle.frag` shader foundation (AC: #6)
  - [ ] Basic color mixing based on progress
  - [ ] Ensure "Midnight Magic" colors are supported
- [ ] Update `TreeParticles.tsx` to use custom shader material (AC: #2)
  - [ ] Load `particle.vert` and `particle.frag`
  - [ ] Create `ShaderMaterial` with uniforms
  - [ ] Replace `PointsMaterial` with `ShaderMaterial`
- [ ] Implement "Explosion" trigger logic in `TreeParticles.tsx` (AC: #1, #4)
  - [ ] Connect `onClick` to `useStore.triggerExplosion`
  - [ ] Use `useFrame` to interpolate `uProgress` uniform when `isExploded` is true
  - [ ] Implement damping logic for smooth transition
- [ ] Generate particle attributes for physics (AC: #3)
  - [ ] Calculate `positionEnd` (random float position within bounds)
  - [ ] Calculate `controlPoint` (Start + Explosion Vector)
  - [ ] Pass attributes to geometry
- [ ] Verify performance with `r3f-perf` (AC: #5)
  - [ ] Check FPS during transition
  - [ ] Optimize attribute updates if needed
    </tasks>
  </story>

  <acceptanceCriteria>
1. Clicking the tree triggers the explosion state (`isExploded = true`). [Source: docs/epics.md]
2. Particles transition from tree shape to floating photo cloud using a "GPU State Machine" pattern. [Source: docs/architecture.md]
3. Particle movement follows a Quadratic Bezier curve (Start -> Control Point -> End). [Source: docs/architecture.md]
4. Animation is driven by a `uProgress` uniform (0.0 to 1.0) interpolated over time. [Source: docs/architecture.md]
5. Performance remains >30 FPS during the explosion animation. [Source: docs/prd.md]
6. Explosion visual matches "Midnight Magic" aesthetic (high velocity, rapid damping). [Source: docs/ux-design-specification.md]
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>2.2 Novel UX Patterns</section>
        <snippet>Explosion Physics: High-velocity particle explosion with rapid damping to a floating, weightless state. Visuals: Particles morph from tree colors to Polaroid textures via cross-fade and scale-up.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Document</title>
        <section>5. Novel Pattern Designs</section>
        <snippet>GPU State Machine Interpolation: A vertex-shader-driven animation system controlled by a single uniform `uProgress`. Uses Quadratic Bezier interpolation based on `uProgress` to create an arc trajectory.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>2.2 Novel UX Patterns</section>
        <snippet>Pattern Name: Particle Explosion to Memory Drift. Phases: Explosion &amp; Morphing (Surprise) -> Floating &amp; Immersion.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: Visual Engine Upgrade</title>
        <section>Detailed Design</section>
        <snippet>Services and Modules: Particle Shader (`particle.vert`, `particle.frag`), Tree Component (`TreeParticles.tsx`), Config Module (`assets.ts`), Utils (`math.ts`).</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>src/components/canvas/TreeParticles.tsx</path>
        <kind>component</kind>
        <symbol>TreeParticles</symbol>
        <lines>152-686</lines>
        <reason>Main component to be refactored to use custom shaders and GPU state machine.</reason>
      </item>
      <item>
        <path>src/store/useStore.ts</path>
        <kind>store</kind>
        <symbol>useStore</symbol>
        <lines>40-66</lines>
        <reason>Manages `isExploded` state and `triggerExplosion` action.</reason>
      </item>
      <item>
        <path>src/config/colors.ts</path>
        <kind>config</kind>
        <symbol>TREE_COLOR_PRESETS</symbol>
        <lines>18-25</lines>
        <reason>Defines color presets for the tree particles.</reason>
      </item>
      <item>
        <path>src/config/assets.ts</path>
        <kind>config</kind>
        <symbol>MEMORIES</symbol>
        <lines>36-97</lines>
        <reason>Contains photo paths for the texture atlas.</reason>
      </item>
    </code>
    <dependencies>
      <dep>three</dep>
      <dep>@react-three/fiber</dep>
      <dep>@react-three/drei</dep>
      <dep>zustand</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must use GPU State Machine Interpolation (Vertex Shader) for performance.</constraint>
    <constraint>Must maintain >30 FPS during explosion animation.</constraint>
    <constraint>Must use "Midnight Magic" theme colors defined in `colors.ts`.</constraint>
    <constraint>Do NOT update particle positions on the CPU every frame. Only update the `uProgress` uniform.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AppState</name>
      <kind>interface</kind>
      <signature>
interface AppState {
    treeColor: string;
    particleCount: number;
    isExploded: boolean;
    activePhotoId: string | null;
    setTreeColor: (color: string) => void;
    setParticleCount: (count: number) => void;
    triggerExplosion: () => void;
    resetExplosion: () => void;
    setActivePhoto: (id: string | null) => void;
}
      </signature>
      <path>src/store/useStore.ts</path>
    </interface>
    <interface>
      <name>Shader Uniforms</name>
      <kind>glsl</kind>
      <signature>
uniform float uTime;
uniform float uProgress;
uniform vec3 uColor;
uniform sampler2D uAtlas;
      </signature>
      <path>src/shaders/particle.vert</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest for unit tests. Use `r3f-perf` for performance monitoring.</standards>
    <locations>src/store/useStore.test.ts</locations>
    <ideas>
      <idea>Test `triggerExplosion` action updates `isExploded` to true.</idea>
      <idea>Verify `uProgress` interpolation logic in `TreeParticles.tsx`.</idea>
      <idea>Check FPS drops during explosion using `r3f-perf`.</idea>
    </ideas>
  </tests>
</story-context>



