<story-context id="2-2-explosion-physics" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2-2</storyId>
    <title>Explosion Physics &amp; Shader Upgrade</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-2-explosion-physics.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>the tree to explode with a specific "radial force" and "damping" effect</iWant>
    <soThat>it feels like a release of energy rather than just linear movement</soThat>
    <tasks>
- [ ] Create Shader Files (AC: 1, 2)
  - [ ] Create `src/shaders` directory
  - [ ] Implement `src/shaders/particle.vert` with Quadratic Bezier logic
  - [ ] Implement `src/shaders/particle.frag` with basic color support
- [ ] Refactor `TreeParticles.tsx` for GPU State Machine (AC: 1, 3)
  - [ ] Generate `positionStart` (current tree pos), `positionEnd` (random float pos), `controlPoint` (explosion vector) attributes
  - [ ] Replace `PointsMaterial` with `ShaderMaterial` using new uniforms (`uProgress`, `uTime`)
  - [ ] Update `useFrame` to animate `uProgress` based on `isExploded` state
- [ ] Implement Physics Logic (AC: 2)
  - [ ] Calculate `controlPoint` based on radial explosion force
  - [ ] Calculate `positionEnd` for floating state (random distribution)
- [ ] Performance Optimization (AC: 4)
  - [ ] Ensure attribute generation happens only once (useMemo)
  - [ ] Verify FPS during transition using `r3f-perf`
- [ ] Verify Build and Lint
  - [ ] Run type check
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Given** the `TreeParticles` component, **When** I click the tree (triggering `isExploded`), **Then** the particles should move using the "GPU State Machine" pattern [Source: docs/architecture.md#5-novel-pattern-designs].
2. **And** the movement should follow a Bezier curve (Start -> Explosion Vector -> Float Position) [Source: docs/epics.md#story-22-explosion-physics--shader-upgrade].
3. **And** the animation should be driven by a `uProgress` uniform (0 to 1) interpolated by `useFrame`.
4. **And** performance should remain >30fps during explosion (FR1, FR9).
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.2: Explosion Physics &amp; Shader Upgrade</section>
        <snippet>
As a User,
I want the tree to explode with a specific "radial force" and "damping" effect,
So that it feels like a release of energy rather than just linear movement.

**Acceptance Criteria:**
**Given** the `TreeParticles` component
**When** I click the tree (triggering `isExploded`)
**Then** the particles should move using the "GPU State Machine" pattern (Architecture Spec)
**And** the movement should follow a Bezier curve (Start -> Explosion Vector -> Float Position)
**And** the animation should be driven by a `uProgress` uniform (0 to 1)
**And** performance should remain >30fps during explosion (FR1, FR9)
        </snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Document</title>
        <section>5. Novel Pattern Designs</section>
        <snippet>
### Pattern: GPU State Machine Interpolation

**Problem:** Smoothly transitioning 20,000+ particles from a tree shape to scattered floating photos without CPU bottlenecks.

**Solution:**
A vertex-shader-driven animation system controlled by a single uniform.

**Components:**
1.  **Attributes:**
    -   `positionStart` (vec3): The particle's position in the Tree.
    -   `positionEnd` (vec3): The particle's target position in the Photo Cloud.
    -   `controlPoint` (vec3): A calculated point for the Bezier curve (Start + Explosion Vector).
    -   `uvOffset` &amp; `uvScale` (vec2): Mapping to the specific photo in the Texture Atlas.
2.  **Uniforms:**
    -   `uProgress` (float): 0.0 (Tree) -> 1.0 (Photos). Driven by React state (damped).
    -   `uTime` (float): For floating noise.
3.  **Logic (Vertex Shader):**
    -   Use **Quadratic Bezier** interpolation based on `uProgress` to create an arc trajectory (Explosion -> Drift).
    -   Mix vertex color (Tree) and Texture sample (Photo) based on `uProgress`.
        </snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Document</title>
        <section>4. Project Structure</section>
        <snippet>
src/
├── shaders/                # GLSL Code
│   ├── particle.vert       # Vertex shader (Bezier interpolation)
│   └── particle.frag       # Fragment shader
        </snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>2.2 Novel UX Patterns</section>
        <snippet>
**Pattern Name:** Particle Explosion to Memory Drift

**Phases:**
1.  **Explosion &amp; Morphing (Surprise):**
    *   **Trigger:** Click on Christmas tree.
    *   **Physics:** High-velocity particle explosion with rapid damping to a floating, weightless state (no flying off-screen).
    *   **Visuals:** Particles morph from tree colors to Polaroid textures via cross-fade and scale-up.

2.  **Floating &amp; Immersion:**
    *   **Dynamics:** Photos drift with slow 3D rotation (random X/Y/Z axes).
    *   **Visuals:** Double-sided Polaroid textures (no blank backs).
    *   **Camera:** Automatic "Dolly In" movement to immerse the user in the cloud of memories without losing the overall composition.
        </snippet>
      </doc>
      <doc>
        <path>docs/stories/2-1-theme-config.md</path>
        <title>Story 2.1: Theme &amp; Asset Configuration</title>
        <section>Dev Agent Record</section>
        <snippet>
**Component Size Warning:** `TreeParticles.tsx` is becoming large (>900 lines). Consider extracting shader logic or attribute generation into custom hooks (e.g., `useExplosionAttributes`, `useParticleShader`) to maintain readability.
**Performance:** Continue using `useEffect` for reactive updates where possible, but note that `ShaderMaterial` uniforms are best updated in `useFrame`.
**Theme Integration:** Ensure the new `ShaderMaterial` continues to support the dynamic theme colors implemented in Story 2.1.
        </snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>src/components/canvas/TreeParticles.tsx</path>
        <kind>file</kind>
        <symbol>TreeParticles</symbol>
        <lines>1-905</lines>
        <reason>Currently uses PointsMaterial with CPU-side lerp animation. Needs to be refactored to use ShaderMaterial with GPU-based Bezier interpolation driven by uProgress uniform.</reason>
      </item>
      <item>
        <path>src/shaders/particle.vert.glsl</path>
        <kind>file</kind>
        <symbol>particle.vert</symbol>
        <lines>1-74</lines>
        <reason>Shader already exists with Bezier interpolation logic, but TreeParticles.tsx is not using it. Need to wire up ShaderMaterial with proper attributes (aPositionStart, aPositionEnd, aControlPoint) and uniforms (uProgress, uTime).</reason>
      </item>
      <item>
        <path>src/shaders/particle.frag.glsl</path>
        <kind>file</kind>
        <symbol>particle.frag</symbol>
        <lines>1-28</lines>
        <reason>Fragment shader exists with texture mixing support. Needs to be integrated with ShaderMaterial in TreeParticles.tsx.</reason>
      </item>
      <item>
        <path>src/store/useStore.ts</path>
        <kind>file</kind>
        <symbol>useStore</symbol>
        <lines>1-42</lines>
        <reason>Provides `isExploded` state that should drive `uProgress` uniform animation. The `useFrame` hook in TreeParticles should read `isExploded` and interpolate `uProgress` from 0 to 1.</reason>
      </item>
      <item>
        <path>src/components/canvas/Experience.tsx</path>
        <kind>file</kind>
        <symbol>useFrame</symbol>
        <lines>28-84</lines>
        <reason>Example of useFrame usage in the codebase. TreeParticles should follow similar pattern for animating uProgress uniform.</reason>
      </item>
    </code>
    <dependencies>
      <package name="three" version="^0.165.0" />
      <package name="@react-three/fiber" version="^8.15.0" />
      <package name="zustand" version="^5.0.9" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use GPU State Machine pattern - all position interpolation must happen in vertex shader, not CPU-side.</constraint>
    <constraint>Shader files must be stored in `src/shaders/` directory as per architecture spec.</constraint>
    <constraint>Performance must remain >30fps during explosion transition (FR1, FR9).</constraint>
    <constraint>Attribute generation (positionStart, positionEnd, controlPoint) must happen only once using useMemo to avoid re-computation.</constraint>
    <constraint>ShaderMaterial uniforms (uProgress, uTime) must be updated in useFrame hook, not useEffect.</constraint>
    <constraint>Ensure ShaderMaterial continues to support dynamic theme colors from Story 2.1.</constraint>
    <constraint>Bezier curve must follow pattern: Start (tree position) -> Control Point (explosion vector) -> End (floating position).</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AppState</name>
      <kind>interface</kind>
      <signature>
export interface AppState {
    theme: ThemeName;
    customColor: string;
    particleCount: number;
    isExploded: boolean;
    activePhotoId: string | null;
    triggerExplosion: () => void;
    resetExplosion: () => void;
    setActivePhoto: (id: string | null) => void;
}
      </signature>
      <path>src/store/useStore.ts</path>
      <reason>The `isExploded` boolean state drives the explosion animation. TreeParticles should read this via `useStore` and use it to animate `uProgress` uniform from 0 to 1.</reason>
    </interface>
    <interface>
      <name>TreeParticlesProps</name>
      <kind>interface</kind>
      <signature>
interface TreeParticlesProps {
  isExploded: boolean;
  config: AppConfig;
  onParticlesClick: () => void;
}
      </signature>
      <path>src/components/canvas/TreeParticles.tsx</path>
      <reason>Component receives `isExploded` prop. This should be used to drive `uProgress` uniform animation in useFrame hook.</reason>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Verify performance stays above 30fps during the explosion animation using r3f-perf or browser DevTools.
      Visually verify the "damping" effect (fast start, slow end) matches UX spec requirements.
      Verify that particles follow Bezier curve trajectory (arc shape, not linear).
      Check that attribute generation happens only once (no re-computation on re-render).
      Verify that ShaderMaterial uniforms update smoothly without stuttering.
    </standards>
    <locations>
      src/components/canvas/TreeParticles.tsx
      src/shaders/particle.vert.glsl
      src/shaders/particle.frag.glsl
    </locations>
    <ideas>
      Test that `uProgress` uniform animates smoothly from 0 to 1 when `isExploded` becomes true.
      Test that `uProgress` animates back to 0 when `isExploded` becomes false (implosion).
      Test that Bezier curve creates arc trajectory (not linear movement).
      Test that performance remains >30fps with 20k+ particles during explosion.
      Test that theme colors continue to work with ShaderMaterial (uColor uniform).
      Test that attribute arrays (positionStart, positionEnd, controlPoint) are generated correctly.
      Test that controlPoint calculation creates radial explosion effect.
    </ideas>
  </tests>
</story-context>



